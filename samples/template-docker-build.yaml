# Reusable Template: Docker Build and Push
# This template can be used across multiple pipelines for consistent Docker workflows
version: 1

template:
  name: docker-build-push
  description: "Build and push Docker images with multi-arch support"

  inputs:
    dockerfile:
      type: string
      description: "Path to Dockerfile"
      default: "./Dockerfile"
    context:
      type: string
      description: "Build context path"
      default: "."
    image_name:
      type: string
      description: "Image name without tag"
      required: true
    tags:
      type: array
      description: "List of tags to apply"
      default: ["latest"]
    registry:
      type: string
      description: "Container registry URL"
      default: "docker.io"
    platforms:
      type: array
      description: "Target platforms for multi-arch builds"
      default: ["linux/amd64"]
    build_args:
      type: array
      description: "Build arguments in KEY=value format"
      default: []
    push:
      type: boolean
      description: "Push image after build"
      default: true
    cache_from:
      type: string
      description: "Cache source for builds"
      default: ""
    scan:
      type: boolean
      description: "Run security scan on built image"
      default: true

  steps:
    - name: setup-buildx
      uses: docker/setup-buildx-action@v3

    - name: setup-qemu
      if: ${{ length(inputs.platforms) > 1 }}
      uses: docker/setup-qemu-action@v3

    - name: login-registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: extract-metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ inputs.registry }}/${{ inputs.image_name }}
        tags: ${{ inputs.tags }}

    - name: build-and-push
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile }}
        platforms: ${{ join(inputs.platforms, ',') }}
        push: ${{ inputs.push }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: ${{ join(inputs.build_args, '\n') }}
        cache-from: ${{ inputs.cache_from != '' && inputs.cache_from || format('type=registry,ref={0}/{1}:buildcache', inputs.registry, inputs.image_name) }}
        cache-to: type=registry,ref=${{ inputs.registry }}/${{ inputs.image_name }}:buildcache,mode=max

    - name: security-scan
      if: ${{ inputs.scan }}
      run: |
        trivy image --severity HIGH,CRITICAL \
          --exit-code 1 \
          ${{ inputs.registry }}/${{ inputs.image_name }}:${{ inputs.tags[0] }}
      on-failure:
        errors: [all]
        action:
          ignore: {}

    - name: output-digest
      run: |
        echo "Image built: ${{ inputs.registry }}/${{ inputs.image_name }}"
        echo "Digest: ${{ steps.build.outputs.digest }}"
        echo "image=${{ inputs.registry }}/${{ inputs.image_name }}@${{ steps.build.outputs.digest }}" >> $GITHUB_OUTPUT
